{% extends "dashboard.html" %}

{% block head %}
{{ super() }}
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript">

// Load the Visualization API and the piechart package.
google.load('visualization', '1', {'packages':['corechart']});

// Set a callback to run when the Google Visualization API is loaded.
google.setOnLoadCallback(function() {
  $.ajax({
    url: "/api/project/{{project.id}}",
    dataType:"json",
    success: drawChart
  });
});

function drawChart(json) {
  var chart = new google.visualization.LineChart(document.getElementById('chart_div'));

  var data = new google.visualization.DataTable();
  data.addColumn('datetime', '');
  data.addColumn('number', 'Code Fat');
  data.addColumn('number', 'SLOC');
  
  var result = json['result'];
  for (var i in result) {
    var row = result[i];
    data.addRow([new Date(row[0]*1000), row[1], row[2]]);
  }
  var options = {
    series:{
      1: { targetAxisIndex: 1 }
    },
    vAxes:[
      { title:'code fat' }, 
      { title:'sloc', textStyle: { color: 'red' } } // Axis 1
    ],
    lineWidth: 1,
    //dataOpacity: 1.0,
    //pointSize: 1, 
    explorer: { actions: ['dragToZoom', 'rightClickToReset'] } ,
    width: 600,
    height: 340
  };  
  chart.draw(data, options); 
}  
</script>
{% endblock %}

{% block content %}
<h1 class="page-header">{{project.name}}</h1>
 <div class="container">
  <div class="row">
   <div class="col-md-4">
    <ul class="list-group">
     <li class="list-group-item">Code Fat: <span style="font-size: 5em;">{{summary.codefat_i}}<small>.{{summary.codefat_f}}%</small></span> </li>
     <li class="list-group-item">Total SLOC: {{summary.total_sloc}} </li>
     <li class="list-group-item">Total FLOC: {{summary.total_floc}} </li>
    </ul>
   </div>
   <div class="col-md-8" id="chart_div">
        loading..
   </div>
  </div>
 </div>
<h2 class="sub-header">{{pagination.total_count}} Commit(s)</h2>
<div class="table-responsive">
	<table class="table table-condensed">
		<thead>
			<tr>
				<th>ID</th>
        <th>Title</th>
				<th>Committed by</th>
				<th>When</th>
				<th>&Delta;SLOC</th>
				<th>&Delta;FLOC</th>
				<th>&Delta;Code Fat</th>
			</tr>
		</thead>
		<tbody>
			{% for commit in commits %}
      <tr>
        <td><a class="sha1" href="{{url_for('commit', project_id=project.id,sha1=commit.sha1)}}">{{commit.sha1|truncate(7,True,'')}}</a></td>
        <td><a href="{{url_for('commit', project_id=project.id,sha1=commit.sha1)}}"
        >{{commit.title|truncate(50,True,'...')}}</a></td>
        <td><a href="{{url_for('user', author=commit.author)}}">{{commit.author}}</a></td>
        <td>{{commit.timestamp|datetime}}</td>
        {% if commit.merge %}
        <td colspan="3" style="text-align:center">merge commit</td>
        {% elif commit.sloc == 0 %}
        <td colspan="3" style="text-align:center">compile error</td>
        {% else %}
        <td>{{commit.delta_sloc}}</td>
        <td>{{commit.delta_floc|round(2)}}</td>
        <td>{{commit.delta_codefat|round(2)}}%</td>
        {% endif %}
      </tr>
      {% endfor %}
		</tbody>
	</table>
</div>
  <div class="col-md-12 text-center">
  {% from '_helpers.html' import render_pagination with context %}
  {{render_pagination(pagination)}}
  </div>
{% endblock %}
